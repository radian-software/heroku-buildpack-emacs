#!/bin/bash
# Usage: bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -e
set -o pipefail

BUILD_DIR=$1
# CACHE_DIR=$2
# ENV_DIR=$3

indent() {
  sed -u 's/^/       /'
}

PREFIX=$BUILD_DIR/.heroku/vendor

echo "-----> Install Emacs"

emacs_name=emacs-26.1
emacs_archive=${emacs_name}.tar.xz
emacs_archive_url=https://ftpmirror.gnu.org/emacs/${emacs_archive}

pushd /tmp
curl -L -O ${emacs_archive_url}
tar -xf ${emacs_archive}
cd ${emacs_name}
./configure --without-all --without-x --with-gnutls=yes --prefix="$PREFIX"
make -j9
make install-strip prefix="$PREFIX"
popd

"$PREFIX/bin/emacs" --version | indent

mkdir -p "$BUILD_DIR/.profile.d"
cat << "EOF" > "$BUILD_DIR/.profile.d/emacs.sh"
PATH=$PATH:$HOME/.heroku/vendor/bin
LANG=${LANG:-en_US.UTF-8}
EOF
